import os
from pathlib import Path

from nextlib.openfoam.PyFoamDict.Tools.String import (
    remove_comment, remove_empty
)
from nextlib.openfoam.PyFoamDict.FoamData import FoamData


class FoamCase:
    def __init__(self, path=''):
        self.case_path = ''
        self.regions = []
        self.foam_file = {}

        if path:
            self.set_case_path(path)

    def end(self):
        ...

    def set_case_path(self, path=''):
        self.case_path = path
        self.scan_case_files()
        self.get_case_info()
        self.update()

    def scan_case_files(self) -> dict:
        case_path = Path(self.case_path)

        EXCLUDE_KEY_PARTS = {"0", "0.org", "0.orig", "constant", "system"}
        results = {}

        for p in case_path.rglob("*"):
            if not p.is_file():
                continue

            if p.suffixes:  # suffix: 단일 확장자, suffixes: 다중확장자(ex: tar.gz)
                continue

            rel = p.relative_to(case_path).as_posix()
            parts = rel.split("/")

            filename = parts[-1]

            if filename.endswith("Properties"):
                filename_key = filename.replace("Properties", "Prop")
            else:
                filename_key = filename

            key_parts = []

            for part in parts[:-1]:
                if part not in EXCLUDE_KEY_PARTS:
                    key_parts.append(part)

            key_parts.append(filename_key)

            key = "/".join(key_parts)

            results[key] = rel

        return results

    def get_case_info(self):
        file_info = self.scan_case_files()
        for key, value in file_info.items():
            tmp_foam_data = FoamData()
            tmp_foam_data.set_file('%s/%s' % (self.case_path, value))
            self.foam_file[key] = tmp_foam_data

        this_file_path = os.path.dirname(os.path.abspath(__file__))
        file_data = self.read_file(this_file_path)

        read_data = remove_comment(file_data, 0)
        read_data = remove_empty(read_data)
        split_data = read_data.split('\n')
        for d in split_data:
            if d:
                d = d.split(' ')
                tmp_foam_data = FoamData()
                tmp_foam_data.set_file('%s/%s' % (self.case_path, d[1]))
                if not d[0] in self.foam_file:
                    self.foam_file[d[0]] = tmp_foam_data

    def read_file(self, path):
        data = ''
        if os.path.isfile(path):
            with open(path, 'r') as f:
                data = f.read()
        return data

    def check_name(self, name=''):
        if not name or self.foam_file.get(name) is None:
            return False
        if not self.foam_file[name].foam_data:
            return False
        return True

    def update(self, load_header=True):
        for d in self.foam_file:
            self.foam_file[d].load(load_header)

    def load(self, name=''):
        if not name or not self.check_name(name):
            return False

        self.foam_file[name].load()
        return True

    def save(self, name=''):
        if name == '':
            for d in self.foam_file.values():
                d.save()
        else:
            d = self.foam_file[name]
            d.save()

        return True

    def is_foam_folder(self):
        self.update(False)

        required_files = ['controlDict', 'fvSchemes', 'fvSolution']
        for d in required_files:
            if not self.foam_file[d].is_foam_file():
                return False
            if not os.path.isfile(self.foam_file[d].file_name):
                return False
        return True
