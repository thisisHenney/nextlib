import sys
import re
import numpy as np
import pandas as pd

from PySide6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QPushButton, QFileDialog, QHBoxLayout
)
import pyqtgraph as pg


class FreqAmpPlotWidget(QWidget):
    def __init__(self):
        super().__init__()

        layout = QVBoxLayout(self)

        # PlotWidget 생성 (왼쪽 축)
        self.plot_widget = pg.PlotWidget(background="w")
        self.plot_widget.showGrid(x=True, y=True, alpha=0.3)
        self.plot_widget.setLabel("bottom", "Time (s)")
        self.plot_widget.setLabel("left", "RPS (Hz)")
        self.plot_widget.addLegend()

        layout.addWidget(self.plot_widget)

        # 버튼
        btn_layout = QHBoxLayout()
        self.btn_load = QPushButton("Load Freq-Amp Data")
        self.btn_load.clicked.connect(self.load_file)
        btn_layout.addWidget(self.btn_load)
        layout.addLayout(btn_layout)

        # 오른쪽 축 ViewBox
        self.right_axis = pg.ViewBox()
        self.plot_widget.showAxis("right")
        self.plot_widget.getAxis("right").linkToView(self.right_axis)
        self.plot_widget.getAxis("right").setLabel("Amplitude")

        # 오른쪽 축을 plotWidget 씬에 추가
        self.plot_widget.scene().addItem(self.right_axis)

        # X축 linkage
        self.right_axis.setXLink(self.plot_widget)

        # 크기 조정
        self.plot_widget.getViewBox().sigResized.connect(self.update_views)

    # 좌/우 ViewBox 동기화
    def update_views(self):
        self.right_axis.setGeometry(self.plot_widget.getViewBox().sceneBoundingRect())

    # 파일 불러오기
    def load_file(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Load dat", "", "*.dat")
        if not file_path:
            return

        df = self.parse_dat_file(file_path)
        if df is None:
            return

        self.plot_data(df)

    # Tecplot dat 파일 파싱
    def parse_dat_file(self, path):
        try:
            with open(path, "r", errors="ignore") as f:
                lines = f.readlines()
        except:
            return None

        # VARIABLES 라인 파싱
        var_line = None
        for ln in lines:
            if "VARIABLES" in ln:
                var_line = ln
                break

        if var_line is None:
            print("VARIABLES not found")
            return None

        # VARIABLES="Time" "RPM" "A1" ...
        cols = re.findall(r'"(.*?)"', var_line)
        col_count = len(cols)

        # 숫자로 시작하는 라인만 데이터
        data_lines = [ln for ln in lines if re.match(r"\s*(\d+|\d+\.\d+)", ln)]

        data = []
        for ln in data_lines:
            parts = ln.split()
            if len(parts) == col_count:
                data.append([float(p) for p in parts])

        df = pd.DataFrame(data, columns=cols)
        return df

    # 그래프 그리기
    def plot_data(self, df):
        self.plot_widget.clear()
        self.plot_widget.addLegend()

        # 왼쪽/오른쪽 축 초기화
        left_vb = self.plot_widget.getViewBox()
        self.right_axis.clear()

        time = df[df.columns[0]].values      # Time
        rpm = df[df.columns[1]].values       # RPM
        amp_cols = df.columns[2:]            # A1 ~ A7
        amps = df[amp_cols].values

        # --------------------------
        # 왼쪽 축: RPM
        # --------------------------
        pen_rpm = pg.mkPen(color="black", width=3)
        self.plot_widget.plot(time, rpm, pen=pen_rpm, name="RPM")

        # --------------------------
        # 오른쪽 축: Amp 계열
        # --------------------------
        colors = ["red", "green", "blue", "cyan", "magenta", "orange", "purple"]

        for idx, col in enumerate(amp_cols):
            c = colors[idx % len(colors)]
            pen = pg.mkPen(color=c, width=1)

            curve = pg.PlotCurveItem(time, df[col].values, pen=pen, name=col)
            self.right_axis.addItem(curve)

        # 오른쪽 축 Y범위 = Amp 전체범위 자동 지정
        amp_min = np.nanmin(amps)
        amp_max = np.nanmax(amps)

        # 최소/최대가 같을 때 오류 방지
        if amp_min == amp_max:
            amp_max = amp_min + 1e-6

        self.right_axis.setYRange(amp_min, amp_max)

        # 좌측/우측 X축 싱크
        self.update_views()

        self.plot_widget.getAxis("right").setLabel("Amplitude")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    w = FreqAmpPlotWidget()
    w.resize(1400, 900)
    w.show()
    sys.exit(app.exec())
