# builder.py
from .ast_nodes import ASTDict, ASTEntry, ASTList, ASTCompound, ASTValue
from .cst import CSTToken, CSTDict, CSTList, CSTSeq


def build_ast(cst_node):
    # Root wrapper
    if hasattr(cst_node, "node"):
        return build_ast(cst_node.node)

    # Dict
    if hasattr(cst_node, "entries"):
        # ğŸ”¥ ë£¨íŠ¸ í¬í•¨ ëª¨ë“  dictëŠ” CSTDictì™€ ì—°ê²°
        ast = ASTDict(cst_node=cst_node)

        for entry in cst_node.entries:
            ast.entries[entry.key_token.text] = ASTEntry(
                key=entry.key_token.text,
                value_node=build_ast(entry.value_node),
                cst_entry=entry
            )
        return ast

    # List (í•µì‹¬)
    if hasattr(cst_node, "items"):
        items = cst_node.items
        n = len(items)

        # 1) WORD + { } íŒ¨í„´ì´ ì „ë¶€ë©´ â†’ dictë¡œ ìŠ¹ê²©
        is_named_dict = (
                n % 2 == 0 and
                all(
                    isinstance(items[i], CSTToken) and
                    isinstance(items[i + 1], CSTDict)
                    for i in range(0, n, 2)
                )
        )

        if is_named_dict:
            ast = ASTDict(cst_node=cst_node)  # ìƒìœ„ dict (ì˜ˆ: "3")

            for i in range(0, n, 2):
                key_tok = items[i]
                body = items[i + 1]  # CSTDict (inletì˜ { ... })

                child_ast = build_ast(body)

                # ğŸ”¥ í•µì‹¬: inlet ìì²´ dictê°€ ìê¸° CSTDictë¥¼ ê°€ë¦¬í‚¤ê²Œ í•œë‹¤
                if hasattr(child_ast, "entries"):
                    child_ast.cst_node = body

                ast.entries[key_tok.text] = ASTEntry(
                    key=key_tok.text,
                    value_node=child_ast,
                    cst_entry=None
                )

            return ast

        # 2) compound íŒ¨í„´: ( WORD {..} ) ë˜ëŠ” ( WORD (.. ) ) ë°˜ë³µ
        compounds = []
        i = 0
        while i < n - 1:
            head = items[i]
            body = items[i + 1]
            if isinstance(head, CSTToken) and isinstance(body, (CSTDict, CSTList)):
                compounds.append((head, body))
                i += 2
                continue
            break  # ì¤‘ê°„ì— íŒ¨í„´ì´ ëŠê¸°ë©´ compound listë¡œ ë³´ì§€ ì•ŠìŒ

        if compounds and i == n:
            # ì „ì²´ê°€ head+body ìŒìœ¼ë¡œë§Œ êµ¬ì„±ëœ ê²½ìš° â†’ compound list
            ast = ASTList()
            for head, body in compounds:
                ast.items.append(
                    ASTCompound(
                        head=head.text,
                        body=build_ast(body),
                        cst_node=body  # body spanì„ ë³´ê´€(í•„ìš”í•˜ë©´ headê¹Œì§€ í™•ì¥ ê°€ëŠ¥)
                    )
                )
            return ast

        # 3) ìŠ¤ì¹¼ë¼ ë¦¬ìŠ¤íŠ¸: ( token token token ... ) â†’ python listë¡œ
        scalar_values = []
        for it in items:
            if isinstance(it, CSTToken):
                scalar_values.append(it.text)

            elif isinstance(it, CSTSeq):
                parts = it.parts
                if (
                        len(parts) == 2
                        and isinstance(parts[0], CSTToken)
                        and parts[0].text.isdigit()
                        and isinstance(parts[1], CSTList)
                ):
                    scalar_values.append(build_ast(parts[1]).value)
                else:
                    scalar_values.append(" ".join(
                        p.text for p in parts if isinstance(p, CSTToken)
                    ))

            else:
                # dict / list ê°™ì€ ê²½ìš°ë§Œ ASTë¡œ ìœ ì§€
                v = build_ast(it)
                if isinstance(v, ASTValue):
                    scalar_values.append(v.value)
                else:
                    scalar_values.append(v)

        return ASTValue(value=scalar_values, cst_node=cst_node)

    # Primitive / Seq
    if isinstance(cst_node, CSTSeq):
        parts = cst_node.parts

        # ğŸ”¥ case 1: NUMBER + ( ... )  â†’ list
        if (
                len(parts) == 2
                and isinstance(parts[0], CSTToken)
                and parts[0].text.isdigit()
                and isinstance(parts[1], CSTList)
        ):
            # countëŠ” ë²„ë¦¬ê³  listë§Œ ì‚¬ìš©
            return build_ast(parts[1])

        # ğŸ”¥ case 2: ì¼ë°˜ token ì‹œí€€ìŠ¤ â†’ ë¬¸ìì—´
        text = " ".join(
            p.text for p in parts if isinstance(p, CSTToken)
        )
        return ASTValue(value=text, cst_node=cst_node)

    if hasattr(cst_node, "text"):
        return ASTValue(value=cst_node.text, cst_node=cst_node)

    return ASTValue(value=None, cst_node=cst_node)