import sys
import numpy as np
from PySide6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QFileDialog, QCheckBox
)
import pyqtgraph as pg


# ==================================================
# Plot Widget (3개의 PlotWidget: Y 독립, X 공유)
# ==================================================
class TimeSeriesPlotPanel(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)

        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)

        # 공통 스타일
        def _make_plot(title: str):
            w = pg.PlotWidget()
            w.setBackground("w")
            w.showGrid(x=True, y=True, alpha=0.4)
            w.plotItem.setDownsampling(mode="peak")
            w.plotItem.setClipToView(True)
            w.plotItem.setTitle(title)
            return w

        self.p_raw = _make_plot("Raw Data")
        self.p_filt = _make_plot("Filtered Data (10~10kHz)")
        self.p_mean = _make_plot("Mean Data")

        # 축 라벨: 맨 아래만 Time(s) 표시
        self.p_raw.plotItem.setLabel("left", "Pressure Fluctuation (bar)")
        self.p_filt.plotItem.setLabel("left", "Pressure Fluctuation (bar)")
        self.p_mean.plotItem.setLabel("left", "Pressure Fluctuation (bar)")
        self.p_mean.plotItem.setLabel("bottom", "Time(s)")

        # X축 공유 (패닝/줌 동기화)
        self.p_filt.setXLink(self.p_raw)
        self.p_mean.setXLink(self.p_raw)

        # 초기 curve 생성(재사용)
        self.c_raw = self.p_raw.plot([], [], pen=pg.mkPen((255, 0, 0), width=1), name="Raw")
        self.c_filt = self.p_filt.plot([], [], pen=pg.mkPen((0, 200, 0), width=1), name="Filtered")
        self.c_mean = self.p_mean.plot([], [], pen=pg.mkPen((0, 0, 255), width=2), name="Mean")

        # 레이아웃에 추가
        layout.addWidget(self.p_raw)
        layout.addWidget(self.p_filt)
        layout.addWidget(self.p_mean)

    def set_visibility(self, show_raw: bool, show_filtered: bool, show_mean: bool):
        # 플롯 자체를 숨기면 공간까지 사라져서 보기 좋습니다.
        self.p_raw.setVisible(show_raw)
        self.p_filt.setVisible(show_filtered)
        self.p_mean.setVisible(show_mean)

    def plot_all(self, time_raw=None, raw=None, mean=None, time_filt=None, filtered=None):
        # Raw
        if time_raw is not None and raw is not None:
            self.c_raw.setData(time_raw, raw)
            self.p_raw.enableAutoRange()
        else:
            self.c_raw.setData([], [])

        # Filtered
        if time_filt is not None and filtered is not None:
            self.c_filt.setData(time_filt, filtered)
            self.p_filt.enableAutoRange()
        else:
            self.c_filt.setData([], [])

        # Mean
        if time_raw is not None and mean is not None:
            self.c_mean.setData(time_raw, mean)
            self.p_mean.enableAutoRange()
        else:
            self.c_mean.setData([], [])


# ==================================================
# Main Window (time_02 (OK).py 기반)
# ==================================================
class MainWindow(QWidget):
    def __init__(self):
        super().__init__()

        self.setWindowTitle("Pressure Time Signal Viewer (Independent Y Scales)")

        self.time_raw = None
        self.raw = None
        self.mean = None

        self.time_filt = None
        self.filtered = None

        layout = QVBoxLayout(self)

        # Plot Panel (3개)
        self.plot_panel = TimeSeriesPlotPanel()
        layout.addWidget(self.plot_panel)

        # Controls
        ctrl_layout = QHBoxLayout()

        self.chk_raw = QCheckBox("Raw")
        self.chk_raw.setChecked(True)
        self.chk_raw.stateChanged.connect(self.update_plot)
        ctrl_layout.addWidget(self.chk_raw)

        self.chk_filtered = QCheckBox("Filtered")
        self.chk_filtered.setChecked(True)
        self.chk_filtered.stateChanged.connect(self.update_plot)
        ctrl_layout.addWidget(self.chk_filtered)

        self.chk_mean = QCheckBox("Mean")
        self.chk_mean.setChecked(True)
        self.chk_mean.stateChanged.connect(self.update_plot)
        ctrl_layout.addWidget(self.chk_mean)

        ctrl_layout.addStretch()
        layout.addLayout(ctrl_layout)

        # Buttons
        btn_layout = QHBoxLayout()

        self.btn_raw = QPushButton("Load Raw Data")
        self.btn_raw.clicked.connect(self.load_raw)
        btn_layout.addWidget(self.btn_raw)

        self.btn_filt = QPushButton("Load Filtered Data")
        self.btn_filt.clicked.connect(self.load_filtered)
        btn_layout.addWidget(self.btn_filt)

        layout.addLayout(btn_layout)

    # Raw + Mean 계산
    def load_raw(self):
        file_path, _ = QFileDialog.getOpenFileName(
            self, "Select Raw Data File", "",
            "Data Files (*.dat *.txt)"
        )
        if not file_path:
            return

        data = np.loadtxt(file_path)
        if data.ndim != 2 or data.shape[1] < 2:
            raise ValueError("Raw 파일은 2컬럼(Time, Raw)이어야 합니다.")

        self.time_raw = data[:, 0]
        self.raw = data[:, 1]
        self.mean = self.calc_mean(self.raw)

        self.update_plot()

    def calc_mean(self, raw):
        n = len(raw)
        if n < 5:
            return raw.copy()

        window = max(1, min(500, n // 10))
        kernel = np.ones(window) / window
        return np.convolve(raw, kernel, mode="same")

    # Filtered
    def load_filtered(self):
        file_path, _ = QFileDialog.getOpenFileName(
            self, "Select Filtered Data File", "",
            "Data Files (*.dat *.txt)"
        )
        if not file_path:
            return

        data = np.loadtxt(file_path)
        if data.ndim != 2 or data.shape[1] < 2:
            raise ValueError("Filtered 파일은 2컬럼(Time, Filtered)이어야 합니다.")

        self.time_filt = data[:, 0]
        self.filtered = data[:, 1]

        # time_02(OK).py와 동일한 downsample 유지
        self.time_filt, self.filtered = self.downsample(
            self.time_filt, self.filtered, max_points=8000
        )

        self.update_plot()

    def downsample(self, x, y, max_points=8000):
        n = len(x)
        if n <= max_points:
            return x, y
        step = max(1, n // max_points)
        return x[::step], y[::step]

    # Plot update
    def update_plot(self):
        self.plot_panel.set_visibility(
            show_raw=self.chk_raw.isChecked(),
            show_filtered=self.chk_filtered.isChecked(),
            show_mean=self.chk_mean.isChecked()
        )

        self.plot_panel.plot_all(
            time_raw=self.time_raw,
            raw=self.raw,
            mean=self.mean,
            time_filt=self.time_filt,
            filtered=self.filtered
        )


if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = MainWindow()
    win.resize(1200, 900)
    win.show()
    sys.exit(app.exec())

