import sys
import re
import numpy as np
import pandas as pd

from PySide6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QPushButton, QFileDialog,
    QHBoxLayout, QCheckBox, QGridLayout, QGroupBox
)
import pyqtgraph as pg


class FreqAmpPlotWidget(QWidget):
    def __init__(self):
        super().__init__()

        layout = QVBoxLayout(self)

        # PlotWidget 생성 (왼쪽 축)
        self.plot_widget = pg.PlotWidget(background="w")
        self.plot_widget.showGrid(x=True, y=True, alpha=0.3)
        self.plot_widget.setLabel("bottom", "Time (s)")
        self.plot_widget.setLabel("left", "RPS (Hz)")
        self.plot_widget.addLegend()

        layout.addWidget(self.plot_widget)

        # 체크박스 그룹
        self.checkbox_group = QGroupBox("Signal Visibility")
        cb_layout = QGridLayout()
        self.checkbox_group.setLayout(cb_layout)
        layout.addWidget(self.checkbox_group)

        # 체크박스 dictionary
        self.checkboxes = {}

        # 버튼
        btn_layout = QHBoxLayout()
        self.btn_load = QPushButton("Load Freq-Amp Data")
        self.btn_load.clicked.connect(self.load_file)
        btn_layout.addWidget(self.btn_load)
        layout.addLayout(btn_layout)

        # 오른쪽 축 ViewBox
        self.right_axis = pg.ViewBox()
        self.plot_widget.showAxis("right")
        self.plot_widget.getAxis("right").linkToView(self.right_axis)
        self.plot_widget.getAxis("right").setLabel("Amplitude")

        self.plot_widget.scene().addItem(self.right_axis)
        self.right_axis.setXLink(self.plot_widget)

        # 시그널 보관
        self.curves_left = {}     # RPM
        self.curves_right = {}    # A1~A7

        # View 동기화
        self.plot_widget.getViewBox().sigResized.connect(self.update_views)

    # 좌/우 축 위치 동기화
    def update_views(self):
        self.right_axis.setGeometry(self.plot_widget.getViewBox().sceneBoundingRect())

    # 파일 불러오기
    def load_file(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Load dat", "", "*.dat")
        if not file_path:
            return

        df = self.parse_dat_file(file_path)
        if df is None:
            return

        # 체크박스 초기화
        self.create_checkboxes(df)

        # 그래프 그리기
        self.plot_data(df)

    # 체크박스 생성
    def create_checkboxes(self, df):
        # 초기화
        for cb in self.checkboxes.values():
            cb.deleteLater()
        self.checkboxes.clear()

        cols = df.columns.tolist()

        layout = self.checkbox_group.layout()

        # 기존 체크박스 제거 후 재배치
        for i in reversed(range(layout.count())):
            w = layout.itemAt(i).widget()
            if w:
                w.deleteLater()

        # 체크박스 생성: Time 제외
        row = 0
        col = 0
        for name in cols:
            if name == "Time":
                continue

            cb = QCheckBox(name)
            cb.setChecked(True)
            cb.stateChanged.connect(self.update_visibility)
            self.checkboxes[name] = cb

            layout.addWidget(cb, row, col)
            col += 1
            if col >= 4:
                row += 1
                col = 0

    # Tecplot dat 파일 파싱
    def parse_dat_file(self, path):
        try:
            with open(path, "r", errors="ignore") as f:
                lines = f.readlines()
        except:
            return None

        # VARIABLES 라인 파싱
        var_line = next((ln for ln in lines if "VARIABLES" in ln), None)
        if var_line is None:
            return None

        cols = re.findall(r'"(.*?)"', var_line)
        col_count = len(cols)

        # 숫자로 시작하는 데이터 라인만 추출
        data_lines = [ln for ln in lines if re.match(r"\s*(\d+|\d+\.\d+)", ln)]

        data = []
        for ln in data_lines:
            parts = ln.split()
            if len(parts) == col_count:
                data.append([float(p) for p in parts])

        df = pd.DataFrame(data, columns=cols)
        return df

    # 그래프 그리기
    def plot_data(self, df):
        self.plot_widget.clear()
        legend = self.plot_widget.addLegend()

        time = df["Time"].values
        rpm = df[df.columns[1]].values
        amp_cols = df.columns[2:]
        amps = df[amp_cols]

        self.curves_left.clear()
        self.curves_right.clear()

        # --------------------------
        # 1) 왼쪽 축 RPM 그대로 추가 (레전드 가능)
        # --------------------------
        pen_rpm = pg.mkPen(color="black", width=3)
        rpm_curve = self.plot_widget.plot(time, rpm, pen=pen_rpm, name="RPM")
        self.curves_left["RPM"] = rpm_curve

        # --------------------------
        # 2) 두 축의 독립 스케일 확보
        # --------------------------
        rpm_min, rpm_max = np.min(rpm), np.max(rpm)
        rpm_range = rpm_max - rpm_min

        amp_min, amp_max = np.min(amps.values), np.max(amps.values)
        amp_range = amp_max - amp_min

        if rpm_range == 0:
            rpm_range = 1e-6
        if amp_range == 0:
            amp_range = 1e-6

        # 왼쪽 축: RPM 스케일 유지
        self.plot_widget.setYRange(rpm_min, rpm_max)

        # 오른쪽 축 YRange도 RPM range에 맞추기 (표시 정렬용)
        self.right_axis.setRange(yRange=(rpm_min, rpm_max))

        # Amp → RPM 축 기준으로 변환
        def convert_amp(v):
            return rpm_min + (v - amp_min) * (rpm_range / amp_range)

        # --------------------------
        # 3) Amp 데이터 변환 후 plot_widget에 추가해야 레전드 표시됨
        # --------------------------
        colors = ["red", "green", "blue", "cyan", "magenta", "orange", "purple"]

        for idx, col in enumerate(amp_cols):
            c = colors[idx % len(colors)]
            pen = pg.mkPen(color=c, width=1)

            amp_y = convert_amp(df[col].values)

            # 중요: plot_widget.plot 에 추가해야 레전드가 표시됨
            curve = self.plot_widget.plot(time, amp_y, pen=pen, name=col)
            self.curves_right[col] = curve

        # --------------------------
        # 4) 우측 축 라벨만 표시용으로 유지
        # --------------------------
        self.right_axis.enableAutoRange(False)
        self.plot_widget.getAxis("right").setLabel("Amplitude (scaled)")

        self.update_visibility()
        self.update_views()

    # 체크박스에 따라 선의 표시/숨김 처리
    def update_visibility(self):
        for name, cb in self.checkboxes.items():
            visible = cb.isChecked()

            # RPM(왼쪽)
            if name == "RPM":
                if name in self.curves_left:
                    self.curves_left[name].setVisible(visible)
            # Amp(오른쪽)
            elif name in self.curves_right:
                self.curves_right[name].setVisible(visible)


if __name__ == "__main__":
    app = QApplication(sys.argv)
    w = FreqAmpPlotWidget()
    w.resize(1500, 900)
    w.show()
    sys.exit(app.exec())
