import re
from typing import Any, Optional, Tuple

def find_block_range(content: str, block_name: str) -> Optional[Tuple[int, int]]:
    lines = content.split('\n')
    n = len(lines)

    start = None
    for i, line in enumerate(lines):
        if re.match(rf'^\s*{re.escape(block_name)}\b', line.strip()):
            start = i
            break
    if start is None:
        return None

    i = start + 1
    if i >= n or not lines[i].strip().startswith('{'):
        return None

    brace_level = 0
    for j in range(i, n):
        brace_level += lines[j].count('{')
        brace_level -= lines[j].count('}')
        if brace_level == 0:
            return start, j
    return None

def detect_value_column(line: str) -> Optional[int]:
    """
    '    field           p;' 같은 줄에서
    값('p')가 시작하는 컬럼 번호를 반환 (0-based index).
    """
    if not line.strip():
        return None
    if line.strip().startswith('//'):
        return None
    if line.strip() == '}':
        return None

    # 선행 공백 길이
    leading = len(line) - len(line.lstrip(' '))

    # 키와 나머지 분리
    # 예: "    field           p;" -> tokens = ["field", "p;"]
    tokens = line.strip().split()
    if len(tokens) < 2:
        return None

    key_token = tokens[0]
    # key가 실제로 시작하는 위치
    key_index = line.find(key_token, leading)
    if key_index == -1:
        return None

    # key 끝 이후부터 처음으로 '공백이 아닌' 문자가 나오는 곳이 value 시작
    i = key_index + len(key_token)
    # 공백 스킵
    while i < len(line) and line[i] == ' ':
        i += 1
    if i >= len(line):
        return None
    # i가 값 시작 인덱스
    return i

def add_key_value_line_in_block(
    content: str,
    parent_block: str,
    new_key: str,
    new_value: Any,
) -> str:
    """
    parent_block 블록 안에 'new_key    new_value;' 추가하되,
    바로 윗줄의 값 시작 컬럼에 맞춰 정렬.
    """
    content = content.expandtabs(4)
    lines = content.split('\n')

    br = find_block_range(content, parent_block)
    if br is None:
        return add_key_value_line_global(content, new_key, str(new_value))

    start, end = br
    insert_idx = end  # 닫는 } 바로 위

    # parent_block 들여쓰기 기준 (블록 안 키 기본 들여쓰기)
    m = re.match(r'^(\s*)', lines[start])
    base_indent = (m.group(1) if m else '') + '    '

    val_str = str(new_value).strip()
    if not val_str.endswith(';'):
        val_str += ';'

    # 바로 위에서 값 컬럼 탐색
    value_col = None
    for i in range(insert_idx - 1, start, -1):
        col = detect_value_column(lines[i])
        if col is not None:
            value_col = col
            break

    if value_col is None:
        # 기준 줄을 못 찾으면 그냥 4칸 간격
        new_line = f"{base_indent}{new_key}    {val_str}"
    else:
        # 키 부분 먼저 만들고, 값 시작 컬럼에 맞춰 공백 채움
        key_part = base_indent + new_key
        if len(key_part) >= value_col:
            # 키가 너무 길면 한 칸만 띄움
            new_line = key_part + ' ' + val_str
        else:
            spaces = ' ' * (value_col - len(key_part))
            new_line = key_part + spaces + val_str

    lines.insert(insert_idx, new_line)
    return '\n'.join(lines) + '\n'

def add_block_in_block(
    content: str,
    parent_block: str,
    new_key: str,
    block_body: str | None = None,
) -> str:
    content = content.expandtabs(4)
    lines = content.split('\n')

    br = find_block_range(content, parent_block)
    if br is None:
        return add_block_global(content, new_key, block_body or '')

    start, end = br
    insert_idx = end  # 닫는 } 바로 위

    m = re.match(r'^(\s*)', lines[start])
    base_indent = (m.group(1) if m else '') + '    '
    inner_indent = base_indent + '    '

    body_lines: list[str] = []
    if block_body:
        for bline in block_body.split('\n'):
            if bline.strip() == '':
                body_lines.append('')
            else:
                body_lines.append(inner_indent + bline.rstrip())

    new_lines = [
        f"{base_indent}{new_key}",
        base_indent + "{",
        *body_lines,
        base_indent + "}",
    ]

    for offset, line in enumerate(new_lines):
        lines.insert(insert_idx + offset, line)

    return '\n'.join(lines) + '\n'

def add_key_value_line_global(content: str, new_key: str, new_value: str) -> str:
    content = content.expandtabs(4)
    lines = content.split('\n')

    val_str = new_value.strip()
    if not val_str.endswith(';'):
        val_str += ';'

    line = f"{new_key}    {val_str}"
    lines.append(line)
    return '\n'.join(lines) + '\n'

def add_block_global(content: str, new_key: str, block_body: str) -> str:
    content = content.expandtabs(4)
    lines = content.split('\n')

    base_indent = ''
    inner_indent = '    '

    body_lines: list[str] = []
    for bline in block_body.split('\n'):
        if bline.strip() == '':
            body_lines.append('')
        else:
            body_lines.append(inner_indent + bline.rstrip())

    new_lines = [
        f"{base_indent}{new_key}",
        base_indent + "{",
        *body_lines,
        base_indent + "}",
    ]
    lines.extend(new_lines)
    return '\n'.join(lines) + '\n'

def add_value(
    content: str,
    parent_block: str,
    target_block: str,
    key: str,
    value: Any | None = None,
) -> str:
    """
    - value=None  → key { } 블록 추가
    - value 존재 → key    value; 한 줄 추가
      (값 위치는 윗줄 값 컬럼에 맞춤)
    """
    br_parent = find_block_range(content, parent_block)
    if br_parent is None:
        block_owner = None
    else:
        sub_lines = content.split('\n')[br_parent[0]:br_parent[1] + 1]
        sub_content = '\n'.join(sub_lines)
        br_target = find_block_range(sub_content, target_block)
        block_owner = target_block if br_target is not None else parent_block

    owner = block_owner or parent_block

    if value is None:
        return add_block_in_block(content, owner, key, None)
    else:
        return add_key_value_line_in_block(content, owner, key, value)

# ===================== 예제 =====================

if __name__ == "__main__":
    original = """functions
{
    probes1
    {
        type            probes;
        field           p;
    }

    probes2
    {
        type            probes;
        field           T;
    }
}
"""

    print("=== 원본 ===")
    print(original)

    print("=== probes1 하위에 myField 123; 추가 (p 컬럼에 정렬) ===")
    t = add_value(original, "functions", "probes1", "myField", 123)
    print(t)
