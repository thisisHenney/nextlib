import sys
import numpy as np
from PySide6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QFileDialog, QCheckBox
)
import pyqtgraph as pg


class TimeSeriesPlotWidget(pg.PlotWidget):
    def __init__(self, parent=None):
        super().__init__(parent)

        self.setBackground("w")
        self.showGrid(x=True, y=True, alpha=0.4)

        self.plotItem.setLabel("bottom", "Time(s)")
        self.plotItem.setLabel("left", "Pressure Fluctuation (bar)")

        # ✅ 실시간 패닝 핵심
        self.plotItem.setClipToView(True)
        self.plotItem.setDownsampling(mode="peak")

        self.legend = None

    def plot_all(self,
                 show_raw=True, show_filtered=True, show_mean=True,
                 time_raw=None, raw=None, mean=None,
                 time_filt=None, filtered=None):

        self.clear()
        self.legend = self.plotItem.addLegend(offset=(10, 10))

        # Mean (앞)
        if show_mean and time_raw is not None and mean is not None:
            self.plot(
                time_raw, mean,
                pen=pg.mkPen((0, 0, 255), width=2),
                name="Mean Data"
            )

        # Filtered (중간, ★ auto downsampling)
        if show_filtered and time_filt is not None and filtered is not None:
            curve = self.plot(
                time_filt, filtered,
                pen=pg.mkPen((0, 200, 0), width=1),
                name="Filtered Data (10~10kHz)"
            )
            curve.setDownsampling(auto=True)

        # Raw (뒤)
        if show_raw and time_raw is not None and raw is not None:
            self.plot(
                time_raw, raw,
                pen=pg.mkPen((255, 0, 0), width=1),
                name="Raw Data"
            )

        self.enableAutoRange()


class MainWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Pressure Time Signal Viewer")

        self.time_raw = self.raw = self.mean = None
        self.time_filt = self.filtered = None

        layout = QVBoxLayout(self)
        self.plot = TimeSeriesPlotWidget(self)
        layout.addWidget(self.plot)

        ctrl = QHBoxLayout()

        self.chk_raw = QCheckBox("Raw")
        self.chk_raw.setChecked(True)
        self.chk_raw.stateChanged.connect(self.update_plot)
        ctrl.addWidget(self.chk_raw)

        self.chk_filt = QCheckBox("Filtered")
        self.chk_filt.setChecked(True)
        self.chk_filt.stateChanged.connect(self.update_plot)
        ctrl.addWidget(self.chk_filt)

        self.chk_mean = QCheckBox("Mean")
        self.chk_mean.setChecked(True)
        self.chk_mean.stateChanged.connect(self.update_plot)
        ctrl.addWidget(self.chk_mean)

        ctrl.addStretch()
        layout.addLayout(ctrl)

        btn = QHBoxLayout()
        QPushButton("Load Raw Data", clicked=self.load_raw)
        b1 = QPushButton("Load Raw Data")
        b1.clicked.connect(self.load_raw)
        btn.addWidget(b1)

        b2 = QPushButton("Load Filtered Data")
        b2.clicked.connect(self.load_filtered)
        btn.addWidget(b2)
        layout.addLayout(btn)

    def downsample(self, x, y, max_points=8000):
        if len(x) <= max_points:
            return x, y
        step = max(1, len(x) // max_points)
        return x[::step], y[::step]

    def update_plot(self):
        self.plot.plot_all(
            show_raw=self.chk_raw.isChecked(),
            show_filtered=self.chk_filt.isChecked(),
            show_mean=self.chk_mean.isChecked(),
            time_raw=self.time_raw,
            raw=self.raw,
            mean=self.mean,
            time_filt=self.time_filt,
            filtered=self.filtered,
        )

    def load_raw(self):
        path, _ = QFileDialog.getOpenFileName(self, "Raw File", "", "Data Files (*.dat *.txt)")
        if not path:
            return

        data = np.loadtxt(path)
        self.time_raw = data[:, 0]
        self.raw = data[:, 1]
        self.mean = np.convolve(self.raw, np.ones(200) / 200, mode="same")

        self.update_plot()

    def load_filtered(self):
        path, _ = QFileDialog.getOpenFileName(self, "Filtered File", "", "Data Files (*.dat *.txt)")
        if not path:
            return

        data = np.loadtxt(path)
        self.time_filt = data[:, 0]
        self.filtered = data[:, 1]

        # ★ OK 버전 핵심
        self.time_filt, self.filtered = self.downsample(
            self.time_filt, self.filtered, max_points=8000
        )

        self.update_plot()


if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = MainWindow()
    win.resize(1200, 650)
    win.show()
    sys.exit(app.exec())

